# Currency Rates API

Асинхронный backend-сервис на FastAPI для работы с курсами валют.

Сервис реализует:

- REST API
- WebSocket для уведомлений в реальном времени
- фоновую задачу, забирающую данные с внешнего сервиса через httpx
- интеграцию с брокером сообщений NATS (публикация и подписка)
- асинхронную работу с БД (SQLite + SQLAlchemy)

---

## Цель работы

Реализован сервис, соответствующий формулировке:

«Асинхронный Backend: REST API + WebSocket + Фоновая задача + NATS»

---

## Соответствие требованиям задания

### 1) REST API

Используются следующие endpoints (структура, указанная в задании):

- `GET    /items`        – список элементов (курсов валют)
- `GET    /items/{id}`   – получить элемент по id
- `POST   /items`        – создать элемент
- `PATCH  /items/{id}`   – обновить элемент
- `DELETE /items/{id}`   – удалить элемент
- `POST   /tasks/run`    – принудительно запустить фоновую задачу

Все обработчики реализованы асинхронно (async def), работа с БД также асинхронная (SQLite через SQLAlchemy + aiosqlite).

### 2) WebSocket `/ws/items`

Реализован WebSocket-эндпоинт:

- `WS /ws/items` — канал для уведомлений в реальном времени.

Функциональность:

- клиент подключается к `/ws/items`
- получает сообщения в формате JSON:
  - о создании / изменении / удалении объектов (`items`)
  - о данных, полученных фоновой задачей
- отправка идёт через менеджер WebSocket-подключений.

### 3) Фоновая задача

Фоновая задача:

- автоматически запускается каждые `TASK_INTERVAL_SECONDS` секунд (значение задаётся в `.env`)
- делает HTTP-запрос к внешнему API через `httpx`
- обрабатывает ответ (курсы валют)
- сохраняет/обновляет данные в БД (SQLite)
- публикует событие в NATS в канал, например `items.updates`
- рассылает уведомления всем подключённым WebSocket-клиентам

Ручной запуск фоновой задачи реализован через:

- `POST /tasks/run`

### 4) NATS

Интеграция с NATS:

- используется клиент `nats-py` (asyncio)
- реализована публикация сообщений в канал `items.updates` при:
  - создании элемента
  - обновлении элемента
  - удалении элемента
  - обновлении данных фоновой задачей
- реализована подписка на канал `items.updates`:
  - входящие сообщения логируются
  - при необходимости могут использоваться для обновления локальной БД и/или отправки уведомлений в WebSocket

Если NATS недоступен, сервис продолжает работу (REST + WebSocket + фоновые задачи), а ошибки NATS логируются.

### 5) Асинхронная БД

- БД: SQLite
- Драйвер: `aiosqlite`
- ORM: SQLAlchemy (асинхронный engine и session)
- модели и схемы вынесены отдельно

---

## Как запустить проект

Минимальный набор шагов.

### 1. Установка зависимостей

Находясь в корне проекта:

```bash
pip install -r requirements.txt
```
(При необходимости предварительно активируйте виртуальное окружение.)

### 2. Настройка .env

Файл .env уже добавлен в проект и содержит значения по умолчанию. При необходимости их можно изменить.

Пример содержимого:
```DATABASE_URL=sqlite+aiosqlite:///./currency.db

NATS_URL=nats://localhost:4222

TASK_INTERVAL_SECONDS=60

EXCHANGE_RATES_API_URL=https://api.exchangerate-api.com/v4/latest/USD

# Тип источника данных:
# "fiat"  – фиатные валюты (внешний API)
# "crypto" – криптовалюты (Binance)
# "mock"  – тестовые случайные данные
API_TYPE=crypto
```

Если ничего не менять, сервис будет использовать SQLite-файл currency.db в текущей директории и попытку подключиться к NATS по адресу nats://localhost:4222.

### 3. Запуск NATS (по желанию, для проверки интеграции)
Если нужна полноценная работа с NATS, поднимите сервер.

Пример через Docker:
```
docker run -d -p 4222:4222 nats:latest
```

Пример для macOS через Homebrew:
```
brew install nats-server
brew services start nats-server
```
Если NATS не запущен, сервис всё равно работает, но без обмена событиями через брокер.

### 4. Запуск приложения
```
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

После запуска
Swagger UI: http://localhost:8000/docs

Для WebSocket можно использовать файл websocket_test.html в корне проекта: откройте его в браузере.


## REST API (кратко)
	GET /items — список всех элементов (курсов)
	GET /items/{id} — получить элемент по id
	POST /items — создать новый элемент
	PATCH /items/{id} — обновить существующий элемент
	DELETE /items/{id} — удалить элемент
	POST /tasks/run — вручную запустить фоновую задачу

## WebSocket

Эндпоинт: `WS /ws/items`

Пример логики работы:

1. Клиент устанавливает соединение с `ws://localhost:8000/ws/items`.
2. При изменениях данных или выполнении фоновой задачи сервер отправляет JSON-сообщения:
   - тип события (создание, обновление, удаление, обновление курсов);
   - данные объекта или агрегированные значения.

---

## Фоновая задача

Фоновая задача:

- запускается автоматически по таймеру (`TASK_INTERVAL_SECONDS`);
- получает данные с внешнего API (`EXCHANGE_RATES_API_URL` или другой источник в зависимости от `API_TYPE`);
- сохраняет/обновляет записи в SQLite;
- публикует событие в NATS;
- уведомляет WebSocket-клиентов.

Ручной запуск:

- `POST /tasks/run`

---

## NATS

Канал, используемый для обмена событиями:

- например, `items.updates`.

Сервис:

- публикует туда сообщения при изменениях данных;
- подписывается на этот канал и обрабатывает входящие сообщения;
- при получении внешних событий может:
  - логировать их;
  - обновлять локальную БД;
  - отправлять уведомления в WebSocket.

---

## Технологический стек

- FastAPI  
- httpx  
- NATS (`nats-py`, asyncio)  
- uvicorn  
- SQLite  
- SQLAlchemy (асинхронный engine/session)  
- Pydantic  
- WebSockets (`fastapi.WebSocket`)

